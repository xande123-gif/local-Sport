<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Local Sport</title>
  <style>
    /* Estilos permanecem os mesmos */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { display: flex; height: 100vh; }
    .mapa { flex: 2; }
    #map { width: 100%; height: 100%; background-color: #eee; }
    .barra-pesquisa {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      background: #f5f5f5;
    }
    .barra-pesquisa h2 { margin-bottom: 15px; color: #222; }
    .barra-pesquisa input {
      padding: 10px;
      font-size: 1em;
      border: 1px solid #aaa;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .resultados { flex: 1; overflow-y: auto; }
    .local {
      background: #fff;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: 0.2s;
    }
    .local:hover { background: #e8f0ff; }
    .local strong { display: block; font-size: 1.1em; color: #0055cc; }
    .local span { font-size: 0.9em; color: #555; }
  </style>
</head>
<body>
  <div class="mapa">
    <div id="map"></div>
  </div>

  <div class="barra-pesquisa">
    <h2>Buscar Esporte</h2>
    <input type="text" id="pesquisa" placeholder="Ex: Academia, Futebol, Natação...">
    <div class="resultados" id="listaLocais"></div>
  </div>

  <script>
    let map;
    let placesService;
    let infoWindow;
    let markers = []; // Array para guardar os marcadores e poder limpá-los

    function initMap() {
      const portoAlegre = { lat: -30.0346, lng: -51.2177 };

      // 1. Inicializar o mapa do Google
      map = new google.maps.Map(document.getElementById('map'), {
        center: portoAlegre,
        zoom: 12,
      });

      // 2. Inicializar o serviço de busca de locais (Places)
      placesService = new google.maps.places.PlacesService(map);
      
      // 3. Janela de informações para mostrar detalhes no marcador
      infoWindow = new google.maps.InfoWindow();

      // 4. Adicionar o listener ao campo de busca
      const pesquisaInput = document.getElementById('pesquisa');
      pesquisaInput.addEventListener('input', () => {
        realizarBusca(pesquisaInput.value);
      });
    }

    // Função para realizar a busca na API
    function realizarBusca(query) {
      limparResultados(); // Limpa marcadores e lista anteriores
      
      if (query.trim() === "") {
        return; // Não busca se o campo estiver vazio
      }

      // Constrói a requisição para a API
      const request = {
        query: query + " em Porto Alegre", // Adiciona "em Porto Alegre" para refinar a busca
        location: map.getCenter(),
        radius: '10000', // 10km de raio a partir do centro do mapa
        fields: ['name', 'geometry', 'formatted_address', 'place_id'],
      };

      // Chama o serviço de busca de texto
      placesService.textSearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && results) {
          // Ajusta os limites do mapa para exibir todos os resultados
          const bounds = new google.maps.LatLngBounds();
          
          results.forEach(place => {
            criarMarcador(place);
            adicionarLocalNaLista(place);
            if (place.geometry && place.geometry.location) {
              bounds.extend(place.geometry.location);
            }
          });
          map.fitBounds(bounds); // Encaixa o mapa nos limites dos marcadores
        } else {
            document.getElementById('listaLocais').innerHTML = "Nenhum resultado encontrado.";
        }
      });
    }

    // Limpa a lista e os marcadores do mapa
    function limparResultados() {
      document.getElementById('listaLocais').innerHTML = "";
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }
    
    // ===================================================================
    // AQUI ESTÁ A MUDANÇA PRINCIPAL!
    // ===================================================================
    function adicionarLocalNaLista(place) {
      const listaLocais = document.getElementById('listaLocais');
      const div = document.createElement('div');
      div.className = "local";
      div.innerHTML = `<strong>${place.name}</strong><span>${place.formatted_address}</span>`;
      
      div.onclick = () => {
        // 1. Ação no mapa interno: centraliza e mostra informações (opcional, mas bom para UX)
        map.setCenter(place.geometry.location);
        map.setZoom(15);
        const markerCorrespondente = markers.find(m => m.placeId === place.place_id);
        if (markerCorrespondente) {
             infoWindow.setContent(`<b>${place.name}</b><br>${place.formatted_address}`);
             infoWindow.open(map, markerCorrespondente);
        }

        // 2. Ação principal: abrir rota no Google Maps em nova aba
        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();
        
        // Esta URL instrui o Google Maps a traçar uma rota da "localização atual" para o destino
        const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

        // Abre a URL em uma nova aba do navegador
        window.open(directionsUrl, '_blank');
      };
      listaLocais.appendChild(div);
    }

    // Cria um marcador no mapa para um local
    function criarMarcador(place) {
      if (!place.geometry || !place.geometry.location) return;

      const marker = new google.maps.Marker({
        map: map,
        position: place.geometry.location,
        title: place.name,
      });

      marker.placeId = place.place_id; // Adiciona o place_id para referência futura
      markers.push(marker); // Adiciona ao array de marcadores

      // Adiciona um evento de clique ao marcador
      google.maps.event.addListener(marker, "click", () => {
        // Ao clicar no marcador, também abre a rota
        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();
        const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        window.open(directionsUrl, '_blank');
      });
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAu2-3j9EgmfbBNoGkrblXLWB5ZER3KNQU&libraries=places&callback=initMap">
  </script>
</body>
</html>